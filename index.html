<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idle Ants - Ant Colony Simulation Game</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Primary game entry point - works for both development and production -->
    
    <!-- Debug mode configuration -->
    <script>
        // Set debug mode based on environment or query parameter
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const debugParam = urlParams.get('debug');
            
            // Pre-setup for namespace
            window.debugMode = isLocalhost || debugParam === 'true';
            
            if (window.debugMode) {
                console.log('Debug mode enabled - running locally');
            }
        })();
    </script>
    
    <!-- Core namespace must be loaded first -->
    <script src="src/core/Namespace.js"></script>
    <script>
        // Set debug mode after namespace is loaded
        if (window.IdleAnts && window.debugMode) {
            window.IdleAnts.Config.debug = window.debugMode;
        }
    </script>
</head>
<body>
    <!-- Preload audio files as HTML elements to avoid CORS issues -->
    <div style="display:none;">
        <!-- Background Music -->
        <audio id="bgm_main_theme" preload="auto" loop>
            <source src="assets/audio/main_theme.mp3" type="audio/mpeg">
        </audio>
        <!-- Old Main Theme -->
        <audio id="bgm_old_main_theme" preload="auto" loop>
            <source src="assets/audio/old_main_theme_daft_punk.mp3" type="audio/mpeg">
        </audio>
        <!-- Boss Theme -->
        <audio id="bgm_anteater_boss" preload="auto" loop>
            <source src="assets/audio/anteater_boss_music.mp3" type="audio/mpeg">
        </audio>
        <!-- Miniboss Theme -->
        <audio id="bgm_miniboss_theme" preload="auto" loop>
            <source src="assets/audio/miniboss_bgm.mp3" type="audio/mpeg">
        </audio>
        <!-- Victory Theme -->
        <audio id="bgm_victory_theme" preload="auto">
            <source src="assets/audio/victory_music.mp3" type="audio/mpeg">
        </audio>
        <!-- Game Over Theme -->
        <audio id="bgm_game_over_theme" preload="auto">
            <source src="assets/audio/game_over_music.mp3" type="audio/mpeg">
        </audio>
        <!-- Sound Effects -->
        <audio id="sfx_ant_spawn" preload="auto">
            <source src="assets/audio/ant_spawn.mp3" type="audio/mpeg">
        </audio>
    </div>
    
    <!-- Audio start overlay -->
    <div id="start-audio-overlay">
        <button id="start-audio-button">
            <i class="fas fa-music"></i> Click to Start Game with Music
        </button>
    </div>

    <div id="game-container">
        <button id="ui-toggle" title="Toggle UI"><i class="fas fa-chevron-up"></i></button>
        <div id="ui-container">
            <div id="game-title">
                <i class="fas fa-bug"></i> Adil Ants
            </div>
            <div id="resources">
                <div id="food">Food: <span id="food-count">0</span></div>
                <div id="food-rate">
                    <div>Rate: <span id="food-per-second-actual">0.0</span>/s</div>
                    <div>Food: <span id="food-type">Basic</span></div>
                </div>
                <div id="ants">Ants: <span id="ant-count">1</span>/<span id="ant-max">10</span></div>
                <div id="flying-ant-stats" class="hidden">Flying: <span id="flying-ant-count">0</span>/<span id="flying-ant-max">0</span></div>
                <div id="car-ant-resource-stats" class="hidden">Car Ants: <span id="car-ant-resource-count">0</span>/<span id="car-ant-resource-max">0</span></div>
                <div id="fire-ant-resource-stats" class="hidden">Fire Ants: <span id="fire-ant-resource-count">0</span>/<span id="fire-ant-resource-max">0</span></div>
            </div>
            <!-- New Modal-Based Action Bar -->
            <div id="action-bar">
                <button id="colony-btn" class="action-btn">
                    <i class="fas fa-bug"></i>
                    <span>Colony</span>
                </button>
                <button id="upgrades-btn" class="action-btn">
                    <i class="fas fa-arrow-up"></i>
                    <span>Upgrades</span>
                </button>
                <button id="automation-btn" class="action-btn">
                    <i class="fas fa-cog"></i>
                    <span>Automation</span>
                </button>
                <button id="challenges-btn" class="action-btn">
                    <i class="fas fa-trophy"></i>
                    <span>Challenges</span>
                </button>
                <button id="leaderboard-btn" class="action-btn">
                    <i class="fas fa-crown"></i>
                    <span>Leaderboard</span>
                </button>
                <button id="debug-victory-btn" class="action-btn" style="background: #ff6b6b; display: none;">
                    <i class="fas fa-bug"></i>
                    <span>Debug Victory</span>
                </button>
                <button id="debug-challenges-btn" class="action-btn" style="background: #ff9800; display: none;">
                    <i class="fas fa-trophy"></i>
                    <span>Debug Challenges</span>
                </button>
                <button id="settings-btn" class="action-btn">
                    <i class="fas fa-sliders-h"></i>
                    <span>Settings</span>
                </button>
            </div>

            <!-- Keep original upgrade elements hidden for backward compatibility -->
            <div id="colony-modal" class="modal-backdrop">
                <div class="modal-container">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-bug"></i>
                            Colony Management
                        </div>
                        <button class="modal-close" onclick="closeModal('colony-modal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="modal-section">
                            <h3>Basic Ants</h3>
                            <button id="modal-buy-ant" class="modal-btn">
                                <span><i class="fas fa-plus"></i>Buy Ant</span>
                                <span id="modal-ant-cost">10</span>
                            </button>
                            <button id="modal-expand-colony" class="modal-btn">
                                <span><i class="fas fa-expand"></i>Expand Colony</span>
                                <span id="modal-expand-cost">100</span>
                            </button>
                        </div>
                        <div class="modal-section">
                            <h3>Queen</h3>
                            <button id="modal-unlock-queen" class="modal-btn" style="display: none;">
                                <span><i class="fas fa-crown"></i>Unlock Queen</span>
                                <span id="modal-unlock-queen-cost">1000</span>
                            </button>
                            <button id="modal-upgrade-queen" class="modal-btn">
                                <span><i class="fas fa-arrow-up"></i>Upgrade Queen</span>
                                <span id="modal-upgrade-queen-cost">2000</span>
                            </button>
                            <div id="modal-queen-stats" class="modal-stats">
                                Level: <span id="modal-queen-level">0</span>/5 | 
                                Spawn: <span id="modal-queen-larvae-capacity">1 per spawn</span> | 
                                Rate: <span id="modal-queen-larvae-rate">60-120</span>s
                            </div>
                        </div>
                        <div class="modal-section">
                            <h3>Flying Ants</h3>
                            <button id="modal-unlock-flying-ants" class="modal-btn">
                                <span><i class="fas fa-feather-alt"></i>Unlock Flying Ants</span>
                                <span id="modal-flying-ant-unlock-cost">500</span>
                            </button>
                            <button id="modal-buy-flying-ant" class="modal-btn hidden">
                                <span><i class="fas fa-plus"></i>Buy Flying Ant</span>
                                <span id="modal-flying-ant-cost">100</span>
                            </button>
                            <button id="modal-expand-flying-ants" class="modal-btn hidden">
                                <span><i class="fas fa-expand"></i>Expand Flying</span>
                                <span id="modal-expand-flying-cost">150</span>
                            </button>
                        </div>
                        <div class="modal-section">
                            <h3>Super Ants</h3>
                            <button id="modal-unlock-car-ants" class="modal-btn">
                                <span><i class="fas fa-car"></i>Car Ants</span>
                                <span id="modal-car-ant-unlock-cost">10000</span>
                            </button>
                            <button id="modal-buy-car-ant" class="modal-btn hidden">
                                <span><i class="fas fa-plus"></i>Buy Car Ant</span>
                                <span id="modal-car-ant-cost">2500</span>
                            </button>
                            <button id="modal-expand-car-ants" class="modal-btn hidden">
                                <span><i class="fas fa-expand"></i>Expand Car Ant Bay</span>
                                <span id="modal-expand-car-ant-cost">5000</span>
                            </button>
                            <button id="modal-unlock-fire-ants" class="modal-btn">
                                <span><i class="fas fa-fire"></i>Fire Ants</span>
                                <span id="modal-fire-ant-unlock-cost">20000</span>
                            </button>
                            <button id="modal-buy-fire-ant" class="modal-btn hidden">
                                <span><i class="fas fa-plus"></i>Buy Fire Ant</span>
                                <span id="modal-fire-ant-cost">5000</span>
                            </button>
                            <button id="modal-expand-fire-ants" class="modal-btn hidden">
                                <span><i class="fas fa-expand"></i>Expand Fire Ant Bay</span>
                                <span id="modal-expand-fire-ant-cost">10000</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upgrades Modal -->
            <div id="upgrades-modal" class="modal-backdrop">
                <div class="modal-container">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-arrow-up"></i>
                            Upgrades
                        </div>
                        <button class="modal-close" onclick="closeModal('upgrades-modal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="modal-section">
                            <h3>Core Upgrades</h3>
                            <button id="modal-upgrade-food" class="modal-btn">
                                <span><i class="fas fa-arrow-up"></i>Food Production</span>
                                <span id="modal-food-upgrade-cost">50</span>
                            </button>
                            <button id="modal-upgrade-speed" class="modal-btn">
                                <span><i class="fas fa-bolt"></i>Movement Speed</span>
                                <span id="modal-speed-upgrade-cost">75</span>
                            </button>
                            <button id="modal-upgrade-strength" class="modal-btn">
                                <span><i class="fas fa-dumbbell"></i>Ant Strength</span>
                                <span id="modal-strength-upgrade-cost">100</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Automation Modal -->
            <div id="automation-modal" class="modal-backdrop">
                <div class="modal-container">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-cog"></i>
                            Automation
                        </div>
                        <button class="modal-close" onclick="closeModal('automation-modal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="modal-section">
                            <h3>Automated Systems</h3>
                            <button id="modal-unlock-autofeeder" class="modal-btn">
                                <span><i class="fas fa-seedling"></i>Unlock Autofeeder</span>
                                <span id="modal-autofeeder-cost">500</span>
                            </button>
                            <button id="modal-upgrade-autofeeder" class="modal-btn hidden">
                                <span><i class="fas fa-arrow-up"></i>Upgrade Autofeeder</span>
                                <span id="modal-autofeeder-upgrade-cost">500</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Modal -->
            <div id="settings-modal" class="modal-backdrop">
                <div class="modal-container">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-sliders-h"></i>
                            Settings
                        </div>
                        <button class="modal-close" onclick="closeModal('settings-modal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="modal-section">
                            <h3>Audio</h3>
                            <button id="modal-toggle-sound" class="modal-btn">
                                <span><i class="fas fa-volume-up"></i>Sound: ON</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Keep original upgrade elements hidden for backward compatibility -->
            <div id="upgrades" style="display: none;">
                <div class="upgrade-section">
                    <h3>Ants</h3>
                    <button id="buy-ant" class="upgrade-btn"><i class="fas fa-plus"></i>Buy Ant (<span id="ant-cost">10</span>)</button>
                    <button id="expand-colony" class="upgrade-btn"><i class="fas fa-expand"></i>Expand (<span id="expand-cost">100</span>)</button>
                </div>
                
                <div class="upgrade-section">
                    <h3>Upgrades</h3>
                    <button id="upgrade-food" class="upgrade-btn"><i class="fas fa-arrow-up"></i>Food (<span id="food-upgrade-cost">50</span>)</button>
                    <button id="upgrade-speed" class="upgrade-btn"><i class="fas fa-bolt"></i>Speed (<span id="speed-upgrade-cost">75</span>)</button>
                    <button id="upgrade-strength" class="upgrade-btn"><i class="fas fa-dumbbell"></i>Strength (<span id="strength-upgrade-cost">100</span>)</button>
                </div>
                
                <div class="upgrade-section">
                    <h3>Special</h3>
                    <button id="unlock-flying-ants" class="upgrade-btn special-btn"><i class="fas fa-feather-alt"></i>Flying Ants (<span id="flying-ant-unlock-cost">500</span>)</button>
                    <button id="buy-flying-ant" class="upgrade-btn special-btn hidden"><i class="fas fa-plus"></i>Flying Ant (<span id="flying-ant-cost">100</span>)</button>
                    <button id="expand-flying-ants" class="upgrade-btn special-btn hidden"><i class="fas fa-expand"></i>Expand Flying (<span id="expand-flying-cost">150</span>)</button>
                    <button id="unlock-queen" class="upgrade-btn queen-btn" style="display: none;"><i class="fas fa-crown"></i>Queen Ant (<span id="unlock-queen-cost">1000</span>)</button>
                    <button id="buy-queen" class="upgrade-btn queen-btn" style="display: none;"><i class="fas fa-plus"></i>Buy Queen</button>
                    <button id="upgrade-queen" class="upgrade-btn queen-btn"><i class="fas fa-arrow-up"></i>Upgrade Queen (<span id="upgrade-queen-cost">2000</span>)</button>
                    <div id="queen-stats" style="font-size: 0.8em; margin-top: 5px;">
                        Level: <span id="queen-level">0</span>/5 | 
                        Spawn: <span id="queen-larvae-capacity">1 per spawn</span> | 
                        Rate: <span id="queen-larvae-rate">60-120</span>s
                        <!-- HP will be implemented in a future update -->
                    </div>
                </div>
                
                <div class="upgrade-section">
                    <h3>Super Ants</h3>
                    <button id="unlock-car-ants" class="upgrade-btn special-btn"><i class="fas fa-car"></i>Unlock Car Ant (<span id="car-ant-unlock-cost">10000</span>)</button>
                    <button id="buy-car-ant" class="upgrade-btn special-btn hidden"><i class="fas fa-plus"></i>Buy Car Ant (<span id="car-ant-cost">2500</span>)</button>
                    <button id="expand-car-ants" class="upgrade-btn special-btn hidden"><i class="fas fa-expand"></i>Expand Car Ant Bay (<span id="expand-car-ant-cost">5000</span>)</button>
                    <div id="car-ant-stats" class="hidden" style="font-size: 0.8em; margin-top: 5px;">
                        Car Ants: <span id="car-ant-count">0</span>/<span id="car-ant-max">0</span>
                    </div>

                    <!-- Fire Ants -->
                    <button id="unlock-fire-ants" class="upgrade-btn special-btn"><i class="fas fa-fire"></i>Unlock Fire Ant (<span id="fire-ant-unlock-cost">20000</span>)</button>
                    <button id="buy-fire-ant" class="upgrade-btn special-btn hidden"><i class="fas fa-plus"></i>Buy Fire Ant (<span id="fire-ant-cost">5000</span>)</button>
                    <button id="expand-fire-ants" class="upgrade-btn special-btn hidden"><i class="fas fa-expand"></i>Expand Fire Ant Bay (<span id="expand-fire-ant-cost">10000</span>)</button>
                    <div id="fire-ant-stats" class="hidden" style="font-size: 0.8em; margin-top: 5px;">
                        Fire Ants: <span id="fire-ant-count">0</span>/<span id="fire-ant-max">0</span>
                    </div>
                </div>
                
                <div class="upgrade-section">
                    <h3>Auto</h3>
                    <button id="unlock-autofeeder" class="upgrade-btn automation-btn"><i class="fas fa-seedling"></i>Autofeeder (<span id="autofeeder-cost">500</span>)</button>
                    <button id="upgrade-autofeeder" class="upgrade-btn automation-btn hidden"><i class="fas fa-arrow-up"></i>Autofeeder <span id="autofeeder-level">0</span>/10 (<span id="autofeeder-upgrade-cost">500</span>)</button>
                </div>
                
                <!-- Sound control button -->
                <div class="upgrade-section">
                    <h3>Settings</h3>
                    <button id="toggle-sound" class="settings-btn"><i class="fas fa-volume-up"></i>Sound: ON</button>
                </div>
            </div>
        </div>
        <div id="game-canvas-container"></div>
    </div>

    <!-- Import Pixi.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@7.x/dist/pixi.min.js"></script>
    
    <!-- Import our game scripts in correct order -->
    <script src="src/data/FoodTypes.js"></script>
    <script src="src/data/BossConfigs.js"></script>
    <!-- Effect Classes -->
    <script src="src/effects/Effect.js"></script>
    <script src="src/effects/SpawnEffect.js"></script>
    <script src="src/effects/FoodSpawnEffect.js"></script>
    <script src="src/effects/FoodDropEffect.js"></script>
    <script src="src/effects/FoodCollectEffect.js"></script>
    <script src="src/effects/Trail.js"></script>
    <script src="src/effects/LarvaeEffect.js"></script>
    <script src="src/effects/index.js"></script>
    <!-- Asset Definitions -->
    <script src="assets/AssetDefinition.js"></script>
    <script src="assets/antAssets.js"></script>
    <script src="assets/anteaterBossAsset.js"></script>
    <script src="assets/foodAssets.js"></script>
    <script src="assets/environmentAssets.js"></script>
    '''    <script src="assets/audioAssets.js"></script>
    <script src="assets/bossAssets.js"></script>''
    <!-- Managers -->
    <script src="src/managers/ResourceManager.js"></script>
    <script src="src/managers/AssetManager.js"></script>
    <script src="src/managers/BackgroundManager.js"></script>
    <script src="src/managers/EffectManager.js"></script>
    <script src="src/managers/EntityManager.js"></script>
    <script src="src/managers/AudioManager.js"></script>
    <script src="src/managers/UIManager.js"></script>
    <!-- Notification Manager -->
    <script src="src/managers/NotificationManager.js"></script>
    <!-- Achievement Manager -->
    <script src="src/managers/AchievementManager.js"></script>
    <!-- Daily Challenge Manager -->
    <script src="src/managers/DailyChallengeManager.js"></script>
    <script src="src/managers/camera/CameraManager.js"></script>
    <script src="src/managers/input/InputManager.js"></script>
    <script src="src/managers/CombatManager.js"></script>
    <!-- Entities -->
    <script src="src/entities/AntBase.js"></script>
    <script src="src/entities/Ant.js"></script>
    <script src="src/entities/FlyingAnt.js"></script>
    <script src="src/entities/CarAnt.js"></script>
    <script src="src/entities/QueenAnt.js"></script>
    <script src="src/entities/Larvae.js"></script>
    <script src="src/entities/Food.js"></script>
    <script src="src/entities/Nest.js"></script>
    <script src="src/entities/FireAnt.js"></script>
    <script src="src/entities/GoldenAnt.js"></script>
    <script src="src/entities/Enemy.js"></script>
    <script src="src/entities/GrasshopperEnemy.js"></script>
    <script src="src/entities/WoollyBearEnemy.js"></script>
    <script src="src/entities/CricketEnemy.js"></script>
    <script src="src/entities/MantisEnemy.js"></script>
    <script src="src/entities/BeeEnemy.js"></script>
    <script src="src/entities/HerculesBeetleEnemy.js"></script>
    <script src="src/entities/FrogEnemy.js"></script>
    '''    <script src="src/entities/AnteaterBoss.js"></script>
    <script src="src/entities/TarantulaBoss.js"></script>
    <script src="src/entities/GiantHornetBoss.js"></script>''
    <!-- Leaderboard System -->
    <script src="github-leaderboard.js"></script>
    <script src="LeaderboardManager.js"></script>
    <script src="src/managers/VictoryScreenManager.js"></script>
    <script src="src/managers/GameLeaderboardIntegration.js"></script>
    <!-- Debug Script -->
    <script src="debug-metrics.js"></script>
    <!-- Game Core -->
    <script src="src/Game.js"></script>
    <script src="src/index.js"></script>
    
    <!-- Script to move modals outside UI container for mobile fix -->
    <script src="move_modals.js"></script>
    
    <!-- Script to handle the audio start button -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Show debug buttons only on localhost
            if (window.debugMode) {
                const debugVictoryBtn = document.getElementById('debug-victory-btn');
                const debugChallengesBtn = document.getElementById('debug-challenges-btn');
                if (debugVictoryBtn) debugVictoryBtn.style.display = 'block';
                if (debugChallengesBtn) debugChallengesBtn.style.display = 'block';
            }
            
            const startAudioButton = document.getElementById('start-audio-button');
            const startAudioOverlay = document.getElementById('start-audio-overlay');
            
            if (startAudioButton && startAudioOverlay) {
                startAudioButton.addEventListener('click', function() {
                    // Hide the overlay
                    startAudioOverlay.style.display = 'none';
                    
                    // Resume audio context and start playing music
                    if (IdleAnts.AudioManager) {
                        IdleAnts.AudioManager.resumeAudioContext();
                        
                        // Start playing background music
                        if (IdleAnts.AudioAssets && IdleAnts.AudioAssets.BGM && IdleAnts.AudioAssets.BGM.MAIN_THEME) {
                            IdleAnts.AudioManager.playBGM(IdleAnts.AudioAssets.BGM.MAIN_THEME.id);
                        }
                    }
                });
            }
            
            // Modal System Setup
            setupModalSystem();
        });
        
        // Modal System Functions
        function openModal(modalId, triggerElement) {
            // First, close any currently open modal
            const openModal = document.querySelector('.modal-backdrop.show');
            if (openModal && openModal.id !== modalId) {
                closeModal(openModal.id);
            }
            
            const modal = document.getElementById(modalId);
            if (modal) {
                // Don't position modal dynamically - let CSS handle it
                modal.classList.add('show');
                // Update modal content when opened
                updateModalContent(modalId);
            }
        }
        
        function positionModalNearElement(modal, element) {
            const rect = element.getBoundingClientRect();
            const modalWidth = 320; // Match CSS width
            const modalMaxHeight = window.innerHeight - 120;
            
            // Calculate initial position (below and slightly to the right of the button)
            let left = rect.left;
            let top = rect.bottom + 10;
            
            // Adjust if modal would go off the right edge of screen
            if (left + modalWidth > window.innerWidth - 20) {
                left = window.innerWidth - modalWidth - 20;
            }
            
            // Adjust if modal would go off the left edge of screen
            if (left < 10) {
                left = 10;
            }
            
            // Adjust if modal would go off the bottom of screen
            if (top + modalMaxHeight > window.innerHeight - 20) {
                top = rect.top - modalMaxHeight - 10; // Position above the button instead
            }
            
            // Adjust if modal would go off the top of screen
            if (top < 10) {
                top = 10;
            }
            
            modal.style.left = left + 'px';
            modal.style.top = top + 'px';
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
            }
        }
        
        function setupModalSystem() {
            // Setup action bar buttons
            const actionButtons = {
                'colony-btn': 'colony-modal',
                'upgrades-btn': 'upgrades-modal',
                'automation-btn': 'automation-modal',
                'settings-btn': 'settings-modal'
            };
            
            // Add click listeners to action buttons
            for (const [buttonId, modalId] of Object.entries(actionButtons)) {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.addEventListener('click', (event) => {
                        event.stopPropagation(); // Prevent the click from bubbling to document
                        openModal(modalId, event.target.closest('button'));
                    });
                }
            }
            
            // Special handler for challenges button (doesn't open a modal)
            const challengesBtn = document.getElementById('challenges-btn');
            if (challengesBtn) {
                challengesBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    console.log('Challenges button clicked');
                    try {
                        if (IdleAnts.game && IdleAnts.game.dailyChallengeManager) {
                            console.log('Found dailyChallengeManager, calling showModal');
                            IdleAnts.game.dailyChallengeManager.showModal();
                        } else {
                            console.error('dailyChallengeManager not found or not initialized');
                            alert('Challenges system not available. Please try refreshing the page.');
                        }
                    } catch (error) {
                        console.error('Error opening challenges modal:', error);
                        alert('Failed to open challenges. Please try refreshing the page.');
                    }
                });
            }

            // Special handler for leaderboard button (doesn't open a modal)
            const leaderboardBtn = document.getElementById('leaderboard-btn');
            if (leaderboardBtn) {
                leaderboardBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    console.log('Leaderboard button clicked');
                    if (IdleAnts.game && IdleAnts.game.leaderboardIntegration) {
                        IdleAnts.game.leaderboardIntegration.showLeaderboard();
                    } else {
                        console.log('leaderboardIntegration not found');
                    }
                });
            }

            // Debug button to trigger victory state
            const debugVictoryBtn = document.getElementById('debug-victory-btn');
            if (debugVictoryBtn) {
                debugVictoryBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    console.log('Debug Victory button clicked');
                    if (IdleAnts.game) {
                        // Simulate defeating the anteater boss
                        IdleAnts.game.onBossDefeated('anteater');
                    } else {
                        console.log('Game not found');
                    }
                });
            }

            // Debug button to complete all challenges
            const debugChallengesBtn = document.getElementById('debug-challenges-btn');
            if (debugChallengesBtn) {
                debugChallengesBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    console.log('Debug Challenges button clicked');
                    if (IdleAnts.game && IdleAnts.game.dailyChallengeManager) {
                        IdleAnts.game.dailyChallengeManager.debugCompleteAllChallenges();
                    } else {
                        console.log('Game or dailyChallengeManager not found');
                    }
                });
            }
            
            // Add click-away functionality to close modals
            document.addEventListener('click', (event) => {
                // Check if any modal is open
                const openModal = document.querySelector('.modal-backdrop.show');
                if (openModal) {
                    // Check if the click was outside the modal
                    const isClickInsideModal = openModal.contains(event.target);
                    
                    if (!isClickInsideModal) {
                        closeModal(openModal.id);
                    }
                }
            });
            
            // Setup modal button event listeners
            setupModalButtonListeners();
        }
        
        function setupModalButtonListeners() {
            // Colony Modal Buttons
            const modalBuyAnt = document.getElementById('modal-buy-ant');
            const modalExpandColony = document.getElementById('modal-expand-colony');
            const modalUnlockQueen = document.getElementById('modal-unlock-queen');
            const modalUpgradeQueen = document.getElementById('modal-upgrade-queen');
            const modalUnlockFlying = document.getElementById('modal-unlock-flying-ants');
            const modalBuyFlying = document.getElementById('modal-buy-flying-ant');
            const modalExpandFlying = document.getElementById('modal-expand-flying-ants');
            const modalUnlockCar = document.getElementById('modal-unlock-car-ants');
            const modalBuyCar = document.getElementById('modal-buy-car-ant');
            const modalExpandCar = document.getElementById('modal-expand-car-ants');
            const modalUnlockFire = document.getElementById('modal-unlock-fire-ants');
            const modalBuyFire = document.getElementById('modal-buy-fire-ant');
            const modalExpandFire = document.getElementById('modal-expand-fire-ants');
            
            // Upgrades Modal Buttons
            const modalUpgradeFood = document.getElementById('modal-upgrade-food');
            const modalUpgradeSpeed = document.getElementById('modal-upgrade-speed');
            const modalUpgradeStrength = document.getElementById('modal-upgrade-strength');
            
            // Automation Modal Buttons
            const modalUnlockAutofeeder = document.getElementById('modal-unlock-autofeeder');
            const modalUpgradeAutofeeder = document.getElementById('modal-upgrade-autofeeder');
            
            // Settings Modal Buttons
            const modalToggleSound = document.getElementById('modal-toggle-sound');
            
            // Link modal buttons to original buttons
            if (modalBuyAnt) modalBuyAnt.addEventListener('click', (e) => { e.stopPropagation(); simulateClick('buy-ant'); });
            if (modalExpandColony) modalExpandColony.addEventListener('click', (e) => { e.stopPropagation(); simulateClick('expand-colony'); });
            if (modalUnlockQueen) modalUnlockQueen.addEventListener('click', (e) => { e.stopPropagation(); simulateClick('unlock-queen'); });
            if (modalUpgradeQueen) modalUpgradeQueen.addEventListener('click', (e) => { e.stopPropagation(); simulateClick('upgrade-queen'); });
            if (modalUnlockFlying) modalUnlockFlying.addEventListener('click', (e) => { e.stopPropagation(); simulateClick('unlock-flying-ants'); });
            if (modalBuyFlying) modalBuyFlying.addEventListener('click', (e) => { e.stopPropagation(); simulateClick('buy-flying-ant'); });
            if (modalExpandFlying) modalExpandFlying.addEventListener('click', (e) => { e.stopPropagation(); simulateClick('expand-flying-ants'); });
            if (modalUnlockCar) modalUnlockCar.addEventListener('click', (e) => { e.stopPropagation(); simulateClick('unlock-car-ants'); });
            if (modalBuyCar) modalBuyCar.addEventListener('click', (e) => { e.stopPropagation(); simulateClick('buy-car-ant'); });
            if (modalExpandCar) modalExpandCar.addEventListener('click', (e) => { e.stopPropagation(); simulateClick('expand-car-ants'); });
            if (modalUnlockFire) modalUnlockFire.addEventListener('click', (e) => { e.stopPropagation(); simulateClick('unlock-fire-ants'); });
            if (modalBuyFire) modalBuyFire.addEventListener('click', (e) => { e.stopPropagation(); simulateClick('buy-fire-ant'); });
            if (modalExpandFire) modalExpandFire.addEventListener('click', (e) => { e.stopPropagation(); simulateClick('expand-fire-ants'); });
            
            if (modalUpgradeFood) modalUpgradeFood.addEventListener('click', (e) => { e.stopPropagation(); simulateClick('upgrade-food'); });
            if (modalUpgradeSpeed) modalUpgradeSpeed.addEventListener('click', (e) => { e.stopPropagation(); simulateClick('upgrade-speed'); });
            if (modalUpgradeStrength) modalUpgradeStrength.addEventListener('click', (e) => { e.stopPropagation(); simulateClick('upgrade-strength'); });
            
            if (modalUnlockAutofeeder) modalUnlockAutofeeder.addEventListener('click', (e) => { e.stopPropagation(); simulateClick('unlock-autofeeder'); });
            if (modalUpgradeAutofeeder) modalUpgradeAutofeeder.addEventListener('click', (e) => { e.stopPropagation(); simulateClick('upgrade-autofeeder'); });
            
            if (modalToggleSound) modalToggleSound.addEventListener('click', (e) => { e.stopPropagation(); simulateClick('toggle-sound'); });
        }
        
        function simulateClick(originalButtonId) {
            console.log(`simulateClick called for: ${originalButtonId}`);
            const originalButton = document.getElementById(originalButtonId);
            if (originalButton) {
                console.log(`Found button ${originalButtonId}, clicking it`);
                
                // Create a custom event that doesn't bubble
                const clickEvent = new MouseEvent('click', {
                    bubbles: false,
                    cancelable: true,
                    view: window
                });
                originalButton.dispatchEvent(clickEvent);
                
                // Update modal content after click
                setTimeout(() => {
                    const openModal = document.querySelector('.modal-backdrop.show');
                    if (openModal) {
                        updateModalContent(openModal.id);
                    }
                }, 100);
            } else {
                console.log(`Button ${originalButtonId} not found!`);
            }
        }
        
        function updateModalContent(modalId) {
            // Sync modal button states and costs with original buttons
            const buttonMappings = {
                'colony-modal': [
                    { modal: 'modal-ant-cost', original: 'ant-cost' },
                    { modal: 'modal-expand-cost', original: 'expand-cost' },
                    { modal: 'modal-unlock-queen-cost', original: 'unlock-queen-cost' },
                    { modal: 'modal-upgrade-queen-cost', original: 'upgrade-queen-cost' },
                    { modal: 'modal-queen-level', original: 'queen-level' },
                    { modal: 'modal-queen-larvae-capacity', original: 'queen-larvae-capacity' },
                    { modal: 'modal-queen-larvae-rate', original: 'queen-larvae-rate' },
                    { modal: 'modal-flying-ant-unlock-cost', original: 'flying-ant-unlock-cost' },
                    { modal: 'modal-flying-ant-cost', original: 'flying-ant-cost' },
                    { modal: 'modal-expand-flying-cost', original: 'expand-flying-cost' },
                    { modal: 'modal-car-ant-unlock-cost', original: 'car-ant-unlock-cost' },
                    { modal: 'modal-car-ant-cost', original: 'car-ant-cost' },
                    { modal: 'modal-expand-car-ant-cost', original: 'expand-car-ant-cost' },
                    { modal: 'modal-fire-ant-unlock-cost', original: 'fire-ant-unlock-cost' },
                    { modal: 'modal-fire-ant-cost', original: 'fire-ant-cost' },
                    { modal: 'modal-expand-fire-ant-cost', original: 'expand-fire-ant-cost' }
                ],
                'upgrades-modal': [
                    { modal: 'modal-food-upgrade-cost', original: 'food-upgrade-cost' },
                    { modal: 'modal-speed-upgrade-cost', original: 'speed-upgrade-cost' },
                    { modal: 'modal-strength-upgrade-cost', original: 'strength-upgrade-cost' }
                ],
                'automation-modal': [
                    { modal: 'modal-autofeeder-cost', original: 'autofeeder-cost' },
                    { modal: 'modal-autofeeder-upgrade-cost', original: 'autofeeder-upgrade-cost' }
                ],
                'settings-modal': []
            };
            
            const mappings = buttonMappings[modalId];
            if (mappings) {
                mappings.forEach(mapping => {
                    const modalElement = document.getElementById(mapping.modal);
                    const originalElement = document.getElementById(mapping.original);
                    if (modalElement && originalElement) {
                        modalElement.textContent = originalElement.textContent;
                    }
                });
            }
            
            // Update button visibility and states
            updateModalButtonStates(modalId);
        }
        
        function updateModalButtonStates(modalId) {
            // Helper function to sync button states
            const syncButtonState = (originalId, modalId) => {
                const originalBtn = document.getElementById(originalId);
                const modalBtn = document.getElementById(modalId);
                if (originalBtn && modalBtn) {
                    // Sync visibility
                    modalBtn.style.display = originalBtn.style.display;
                    
                    // Sync disabled state
                    modalBtn.disabled = originalBtn.disabled;
                    
                    // Sync classes (hidden, disabled, etc.)
                    modalBtn.className = originalBtn.className.replace(/^/, 'modal-btn ');
                    
                    // Keep modal-btn class
                    if (!modalBtn.classList.contains('modal-btn')) {
                        modalBtn.classList.add('modal-btn');
                    }
                }
            };
            
            // Colony modal button states
            if (modalId === 'colony-modal') {
                syncButtonState('buy-ant', 'modal-buy-ant');
                syncButtonState('expand-colony', 'modal-expand-colony');
                syncButtonState('unlock-queen', 'modal-unlock-queen');
                syncButtonState('upgrade-queen', 'modal-upgrade-queen');
                syncButtonState('unlock-flying-ants', 'modal-unlock-flying-ants');
                syncButtonState('buy-flying-ant', 'modal-buy-flying-ant');
                syncButtonState('expand-flying-ants', 'modal-expand-flying-ants');
                syncButtonState('unlock-car-ants', 'modal-unlock-car-ants');
                syncButtonState('buy-car-ant', 'modal-buy-car-ant');
                syncButtonState('expand-car-ants', 'modal-expand-car-ants');
                syncButtonState('unlock-fire-ants', 'modal-unlock-fire-ants');
                syncButtonState('buy-fire-ant', 'modal-buy-fire-ant');
                syncButtonState('expand-fire-ants', 'modal-expand-fire-ants');
            }
            
            // Upgrades modal button states
            if (modalId === 'upgrades-modal') {
                syncButtonState('upgrade-food', 'modal-upgrade-food');
                syncButtonState('upgrade-speed', 'modal-upgrade-speed');
                syncButtonState('upgrade-strength', 'modal-upgrade-strength');
            }
            
            // Automation modal button states
            if (modalId === 'automation-modal') {
                syncButtonState('unlock-autofeeder', 'modal-unlock-autofeeder');
                syncButtonState('upgrade-autofeeder', 'modal-upgrade-autofeeder');
            }
            
            // Settings modal - update sound button text
            if (modalId === 'settings-modal') {
                const originalToggleSound = document.getElementById('toggle-sound');
                const modalToggleSound = document.getElementById('modal-toggle-sound');
                if (originalToggleSound && modalToggleSound) {
                    const soundText = originalToggleSound.textContent;
                    modalToggleSound.innerHTML = `<span><i class="fas fa-volume-up"></i>${soundText}</span>`;
                }
            }
        }
    </script>
</body>
</html> 